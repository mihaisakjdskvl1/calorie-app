<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cal Al - Home</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCrIsRUiKYGKyrD8i0wDa3SRZDNrlp2H_E",
      authDomain: "logare-d7168.firebaseapp.com",
      projectId: "logare-d7168",
      storageBucket: "logare-d7168.appspot.com",
      messagingSenderId: "575737128202",
      appId: "1:575737128202:web:666bb22b5048f1030886f3",
      measurementId: "G-DKJVYKE0H9"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    :root {
      --main-yellow: #FFD600;
      --main-black: #111;
      --main-radius: 1rem;
      --main-font: 'Manrope', 'Rubik', Arial, sans-serif;
      --gray-bg: #f6f6f6;
      --gray-hover: #f0f0f0;
      --gray-disabled: #e0e0e0;
      --cal-color: #111;
      --carb-color: #FF9800;
      --protein-color: #E53935;
      --fat-color: #2196F3;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #fff 80%, #f6f6f6 100%);
      color: var(--main-black);
      font-family: var(--main-font);
      width: 100vw;
      overflow-x: hidden;
      min-height: 100vh;
    }
    body {
      min-height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .container {
      width: 100vw;
      max-width: 430px;
      margin: 0 auto;
      padding: 0 1.2rem 6rem 1.2rem;
      box-sizing: border-box;
      position: relative;
      background: linear-gradient(180deg, #fff 80%, #f6f6f6 100%);
      min-height: 100vh;
    }
    /* Top bar */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1.2rem;
      margin-bottom: 0.7rem;
      background: none;
      box-shadow: none;
      border: none;
      gap: 0.7rem;
    }
    .logo {
      font-family: 'Rubik', Arial, sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: none;
      border: none;
      box-shadow: none;
    }
    .logo i {
      font-size: 1.2rem;
      color: var(--main-black);
    }
    .streak {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      background: #fff;
      border-radius: 1rem;
      padding: 0.2rem 0.7rem;
      font-size: 1rem;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
      font-weight: 600;
    }
    .streak i { color: var(--main-yellow); }
    /* Calendar */
    .calendar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 1.2rem;
      gap: 0.2rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 0.5rem;
    }
    .calendar-pill {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2.6rem;
      height: 2.6rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 50%;
      border: 2px dotted #bbb;
      color: #222;
      background: #fff;
      margin: 0 0.1rem;
      transition: background 0.15s, color 0.15s;
      scroll-snap-align: center;
      cursor: pointer;
      user-select: none;
      min-width: 2.6rem;
      min-height: 2.6rem;
      max-width: 2.6rem;
      max-height: 2.6rem;
      box-sizing: border-box;
      text-align: center;
      line-height: 2.6rem;
    }
    .calendar-pill.current, .calendar-pill.selected {
      background: var(--main-black);
      color: #fff;
      border: none;
      font-weight: 700;
    }
    /* Daily summary */
    .summary-card {
      background: #fff;
      border-radius: var(--main-radius);
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
      padding: 1.2rem 1.2rem 1.2rem 1.2rem;
      margin-bottom: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.2rem;
    }
    .summary-main {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
    }
    .summary-main .cal-num {
      font-size: 2.1rem;
      font-weight: 800;
      color: var(--main-black);
      margin-bottom: 0.2rem;
    }
    .summary-main .cal-label {
      font-size: 1.05rem;
      color: #888;
      font-weight: 600;
    }
    .summary-ring {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .summary-ring svg {
      width: 60px;
      height: 60px;
    }
    .summary-ring .ring-icon {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      font-size: 1.3rem;
      color: var(--main-black);
    }
    /* Macro cards */
    .macro-cards {
      display: flex;
      gap: 1.1rem;
      margin-bottom: 1.2rem;
    }
    .macro-card {
      background: #fff;
      border-radius: var(--main-radius);
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
      padding: 1.1rem 0.7rem 0.7rem 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 0;
      flex: 1 1 0;
    }
    .macro-amount {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--main-black);
      margin-bottom: 0.1rem;
      text-align: left;
    }
    .macro-label {
      font-size: 1.05rem;
      font-weight: 600;
      color: #444;
      text-align: left;
      margin-bottom: 0.3rem;
    }
    .macro-ring {
      width: 38px;
      height: 38px;
      margin-bottom: 0.2rem;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .macro-ring svg {
      position: absolute;
      left: 0; top: 0;
    }
    .macro-ring .ring-icon {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      font-size: 1.1rem;
    }
    /* Recently logged */
    .recent-section {
      margin: 2rem 0 1.2rem 0;
    }
    .recent-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--main-black);
      margin-bottom: 0.7rem;
      text-align: left;
    }
    .recent-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding-bottom: 0.5rem;
    }
    .recent-card {
      background: #fff;
      border-radius: var(--main-radius);
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
      min-width: 140px;
      max-width: 100%;
      padding: 0.8rem 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.3rem;
    }
    .recent-food {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--main-black);
    }
    .recent-cal {
      font-size: 0.98rem;
      color: #888;
      font-weight: 500;
    }
    .recent-time {
      font-size: 0.92rem;
      color: #bbb;
      font-weight: 400;
    }
    /* Floating Action Button */
    .fab {
      position: fixed;
      right: 2.2rem;
      bottom: 2.2rem;
      width: 60px;
      height: 60px;
      background: var(--main-black);
      color: #fff;
      border-radius: 50%;
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.13);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      cursor: pointer;
      z-index: 10;
      border: none;
      transition: background 0.18s;
    }
    .fab:active {
      background: #333;
    }
    .fab input[type='file'] {
      display: none;
    }
    .result-modal {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      flex-direction: column;
    }
    .result-modal-content {
      background: #fff;
      border-radius: 1rem;
      padding: 2rem 1.5rem;
      min-width: 250px;
      max-width: 90vw;
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.13);
      color: #222;
      text-align: center;
    }
    .result-modal-content h3 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .result-modal-content .close-btn {
      margin-top: 1.2rem;
      background: var(--main-yellow);
      color: #222;
      border: none;
      border-radius: 1.5rem;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 0.5rem 1.5rem;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
    }
    .camera-modal {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      flex-direction: column;
    }
    .camera-modal video {
      border-radius: 1rem;
      max-width: 90vw;
      max-height: 60vh;
      margin-bottom: 1.2rem;
      background: #000;
    }
    .camera-modal button {
      background: var(--main-yellow);
      color: var(--main-black);
      border: none;
      border-radius: 1.5rem;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 0.8rem 2.2rem;
      margin-top: 0.7rem;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
    }
    .camera-modal .close-btn {
      background: #fff;
      color: #222;
      border: none;
      border-radius: 1.5rem;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 0.5rem 1.5rem;
      margin-top: 0.7rem;
      margin-left: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
    }
    /* Modal for log details */
    .log-modal {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      flex-direction: column;
    }
    .log-modal-content {
      background: #fff;
      border-radius: 1rem;
      padding: 2rem 1.5rem;
      min-width: 250px;
      max-width: 90vw;
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.13);
      color: #222;
      text-align: center;
    }
    .log-modal-content h3 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .log-modal-content .close-btn {
      margin-top: 1.2rem;
      background: var(--main-yellow);
      color: #222;
      border: none;
      border-radius: 1.5rem;
      font-size: 1.1rem;
      font-weight: 700;
      padding: 0.5rem 1.5rem;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
    }
    @media (max-width: 500px) {
      .container {
        padding: 0 0.5rem 6rem 0.5rem;
      }
      .macro-cards {
        flex-direction: column;
        gap: 1.1rem;
      }
    }
    .calendar-pill.today-highlight {
      background: rgba(0,123,255,0.15) !important;
      color: #007bff;
    }
    .calendar-pill.selected {
      background: #111 !important;
      color: #fff !important;
    }
    .recent-log-card {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
      min-width: 140px;
      max-width: 100%;
      padding: 0.8rem 0.7rem;
      margin-bottom: 0.7rem;
      border: none;
      cursor: pointer;
      transition: box-shadow 0.15s, background 0.15s;
      text-align: left;
    }
    .recent-log-card:hover {
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.13);
      background: #f6f6f6;
    }
    .minimal-log {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 0.8rem;
      box-shadow: 0 1px 4px 0 rgba(0,0,0,0.04);
      min-width: 100px;
      max-width: 100%;
      padding: 0.5rem 0.6rem;
      margin-bottom: 0.5rem;
      border: none;
      cursor: pointer;
      transition: box-shadow 0.12s, background 0.12s;
      text-align: left;
    }
    .minimal-log:hover {
      box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
      background: #f6f6f6;
    }
    @media (max-width: 600px) {
      .fab {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 20px;
        margin-left: auto;
        margin-right: auto;
        transform: none;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }
    }
    @media (min-width: 601px) {
    }
  </style>
</head>
<body>
  <script>
    // Blochează accesul la paginile de onboarding dacă utilizatorul e logat
    if (window.location.pathname.match(/welcome|value-prop|height-weight|goal-selection|gender-selection|birthdate|summary/)) {
      if (localStorage.getItem('logged_in')) {
        window.location.href = 'home.html';
      }
    }
  </script>
  <div class="container">
    <div class="top-bar">
      <div class="logo"><i class="fas fa-apple-alt"></i> Cal Al</div>
      <div class="streak"><i class="fas fa-fire"></i> <span id="streakCount">1</span></div>
      <button id="loginBtn" style="background:#fff;border:2px solid #eee;outline:none;cursor:pointer;padding:0.3rem 1.1rem 0.3rem 1.1rem;font-size:1.1rem;color:#111;margin-left:0.7rem;border-radius:1.2rem;font-weight:700;display:none;gap:0.5rem;align-items:center;"><i class="fas fa-user"></i> Login</button>
      <img id="userAvatar" src="" alt="Avatar" style="display:none;width:38px;height:38px;border-radius:50%;margin-left:0.7rem;object-fit:cover;border:2px solid #eee;" />
      <button id="logoutBtn" title="Logout" style="background:none;border:none;outline:none;cursor:pointer;padding:0.3rem 0.7rem 0.3rem 0.7rem;font-size:1.3rem;color:#888;margin-left:0.7rem;"><i class="fas fa-sign-out-alt"></i></button>
    </div>
    <!-- Modal Login (doar Google) -->
    <div id="loginModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:999;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:1.5rem;max-width:370px;width:95vw;margin:auto;padding:2.2rem 1.5rem 1.5rem 1.5rem;box-shadow:0 4px 32px 0 rgba(0,0,0,0.13);position:relative;">
        <button onclick="closeLoginModal()" style="position:absolute;right:1.1rem;top:1.1rem;background:none;border:none;font-size:1.3rem;color:#888;cursor:pointer;">&times;</button>
        <h2 style="text-align:center;font-size:1.5rem;font-weight:800;margin-bottom:2.2rem;">Sign In</h2>
        <button id="googleSignIn" style="width:100%;background:#fff;color:#222;border:2px solid #eee;border-radius:2rem;padding:1rem 0;font-size:1.1rem;font-weight:700;display:flex;align-items:center;justify-content:center;gap:0.7rem;margin-bottom:1.1rem;cursor:pointer;"><i class="fab fa-google"></i> Sign in with Google</button>
        <div id="loginMsg" style="font-size:1rem;color:#d00;text-align:center;margin-top:0.7rem;"></div>
        <div style="font-size:0.95rem;color:#888;text-align:center;margin-top:1.2rem;">By continuing you agree to Cal Al's <a href="#" style="color:#111;text-decoration:underline;">Terms and Conditions</a> and <a href="#" style="color:#111;text-decoration:underline;">Privacy Policy</a></div>
      </div>
    </div>
    <!-- Modal Paywall pentru trial expirat -->
    <div id="paywallModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.65);z-index:2000;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:1.5rem;max-width:370px;width:95vw;margin:auto;padding:2.2rem 1.5rem 1.5rem 1.5rem;box-shadow:0 4px 32px 0 rgba(0,0,0,0.13);position:relative;text-align:center;">
        <h2 style="font-size:1.5rem;font-weight:800;margin-bottom:1.2rem;">Perioadă de probă expirată</h2>
        <div style="font-size:1.1rem;margin-bottom:1.5rem;">Perioada ta gratuită de 2 zile s-a încheiat.<br>Abonează-te pentru a continua să folosești aplicația.</div>
        <button style="background:#111;color:#fff;border:none;border-radius:1.2rem;padding:1rem 2.2rem;font-size:1.1rem;font-weight:700;cursor:not-allowed;opacity:0.6;">Abonează-te (Stripe în curând)</button>
        <div style="font-size:0.98rem;color:#888;margin-top:1.2rem;">Accesul este restricționat până la activarea abonamentului.</div>
      </div>
    </div>
    <!-- Modal Login Obligatoriu -->
    <div id="forceLoginModal" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.65);z-index:3000;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:1.5rem;max-width:370px;width:95vw;margin:auto;padding:2.2rem 1.5rem 1.5rem 1.5rem;box-shadow:0 4px 32px 0 rgba(0,0,0,0.13);position:relative;text-align:center;">
        <h2 style="font-size:1.5rem;font-weight:800;margin-bottom:1.2rem;">Autentificare necesară</h2>
        <div style="font-size:1.1rem;margin-bottom:1.5rem;">Trebuie să te loghezi cu Google pentru a folosi aplicația.</div>
        <button id="forceLoginBtn" style="background:#111;color:#fff;border:none;border-radius:1.2rem;padding:1rem 2.2rem;font-size:1.1rem;font-weight:700;cursor:pointer;">Loghează-te cu Google</button>
      </div>
    </div>
    <div class="calendar" id="calendar"></div>
    <div class="summary-card">
      <div class="summary-main">
        <div class="cal-num" id="calNum">0</div>
        <div class="cal-label" id="calLabel">Calories left</div>
      </div>
      <div class="summary-ring">
        <svg width="60" height="60"><circle cx="30" cy="30" r="25" stroke="#eee" stroke-width="7" fill="none"/><circle id="calRing" cx="30" cy="30" r="25" stroke="#111" stroke-width="7" fill="none" stroke-dasharray="157" stroke-dashoffset="0"/></svg>
        <span class="ring-icon"><i class="fas fa-fire"></i></span>
      </div>
    </div>
    <div class="macro-cards">
      <div class="macro-card">
        <div class="macro-amount" id="proteinLeft">0g</div>
        <div class="macro-label">Protein left</div>
        <div class="macro-ring">
          <svg width="38" height="38"><circle cx="19" cy="19" r="15" stroke="#eee" stroke-width="5" fill="none"/><circle id="proteinRing" cx="19" cy="19" r="15" stroke="#E53935" stroke-width="5" fill="none" stroke-dasharray="94.25" stroke-dashoffset="0"/></svg>
          <span class="ring-icon"><i class="fas fa-drumstick-bite"></i></span>
        </div>
      </div>
      <div class="macro-card">
        <div class="macro-amount" id="carbsLeft">0g</div>
        <div class="macro-label">Carbs left</div>
        <div class="macro-ring">
          <svg width="38" height="38"><circle cx="19" cy="19" r="15" stroke="#eee" stroke-width="5" fill="none"/><circle id="carbsRing" cx="19" cy="19" r="15" stroke="#FF9800" stroke-width="5" fill="none" stroke-dasharray="94.25" stroke-dashoffset="0"/></svg>
          <span class="ring-icon"><i class="fas fa-bread-slice"></i></span>
        </div>
      </div>
      <div class="macro-card">
        <div class="macro-amount" id="fatLeft">0g</div>
        <div class="macro-label">Fat left</div>
        <div class="macro-ring">
          <svg width="38" height="38"><circle cx="19" cy="19" r="15" stroke="#eee" stroke-width="5" fill="none"/><circle id="fatRing" cx="19" cy="19" r="15" stroke="#2196F3" stroke-width="5" fill="none" stroke-dasharray="94.25" stroke-dashoffset="0"/></svg>
          <span class="ring-icon"><i class="fas fa-tint"></i></span>
        </div>
      </div>
    </div>
    <div class="recent-section">
      <div class="recent-title">Recently Logged</div>
      <div class="recent-list" id="recentList"></div>
    </div>
  </div>
  <button class="fab" onclick="openCamera()"><i class="fas fa-camera"></i></button>
  <script>
    // Calendar logic
    function renderCalendar() {
      const days = ['M','T','W','T','F','S','S'];
      const today = new Date();
      const week = [];
      let day = new Date(today);
      day.setDate(today.getDate() - today.getDay() + 1); // Monday
      for(let i=0;i<7;i++){
        week.push({label:days[i],num:day.getDate(),current:day.toDateString()===today.toDateString()});
        day.setDate(day.getDate()+1);
      }
      let html = '';
      week.forEach(d=>{
        html += `<div class="calendar-pill${d.current?' current':''}">${d.label}<span class="day-num">${d.num}</span></div>`;
      });
      document.getElementById('calendar').innerHTML = html;
    }
    renderCalendar();
    // Streak (placeholder)
    document.getElementById('streakCount').textContent = '1';
    // Load macro goals from summary
    function loadGoals() {
      // Folosește aceleași valori ca pe summary.html
      const custom = JSON.parse(localStorage.getItem('custom_macros')||'{}');
      let calories = custom.calories;
      let protein = custom.protein;
      let carbs = custom.carbs;
      let fat = custom.fat;
      // Dacă nu există custom_macros, folosește valorile calculate la configurare
      if (calories === undefined || protein === undefined || carbs === undefined || fat === undefined) {
        calories = parseInt(localStorage.getItem('calories_goal')||'2000');
        protein = parseInt(localStorage.getItem('protein_goal')||'100');
        carbs = parseInt(localStorage.getItem('carbs_goal')||'200');
        fat = parseInt(localStorage.getItem('fat_goal')||'50');
      }
      document.getElementById('calNum').textContent = calories;
      document.getElementById('calLabel').textContent = 'Calories left';
      document.getElementById('proteinLeft').textContent = protein+'g';
      document.getElementById('carbsLeft').textContent = carbs+'g';
      document.getElementById('fatLeft').textContent = fat+'g';
      // Progress rings
      function setRing(id, value, max, ringId) {
        const circle = document.getElementById(ringId);
        const r = 15;
        const c = 2 * Math.PI * r;
        const pct = Math.min(1, value / max);
        circle.setAttribute('stroke-dasharray', c);
        circle.setAttribute('stroke-dashoffset', c * (1 - pct));
      }
      setRing(0, calories, 4000, 'calRing');
      setRing(0, protein, 250, 'proteinRing');
      setRing(0, carbs, 400, 'carbsRing');
      setRing(0, fat, 120, 'fatRing');
    }
    loadGoals();
    // Recently logged (demo data)
    function loadRecent() {
      const demo = [
        {food:'Grocery Basket',cal:320,time:'09:12'},
        {food:'Chicken Salad',cal:410,time:'13:45'},
        {food:'Protein Shake',cal:180,time:'16:10'}
      ];
      let html = '';
      demo.forEach(d=>{
        html += `<div class="recent-card"><div class="recent-food">${d.food}</div><div class="recent-cal">${d.cal} kcal</div><div class="recent-time">${d.time}</div></div>`;
      });
      document.getElementById('recentList').innerHTML = html;
    }
    // loadRecent(); // Eliminat pentru a nu suprascrie logurile reale
    // Interactive horizontal calendar with drag/swipe and tap
    // Setează selectedDayIdx la ziua curentă din săptămână (0=Luni, 6=Duminică)
    const today = new Date();
    let jsDay = today.getDay(); // 0=Sunday, 1=Monday, ...
    // Convertim la 0=Luni, 6=Duminică
    let selectedDayIdx = (jsDay === 0) ? 6 : jsDay - 1;
    function getWeekDays() {
      const days = ['L','M','M','J','V','S','D'];
      const week = [];
      const today = new Date();
      // Găsește luni din săptămâna curentă
      const monday = new Date(today);
      monday.setDate(today.getDate() - ((today.getDay() + 6) % 7));
      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        week.push({
          label: days[i],
          date: d.toDateString(),
          dateObj: d
        });
      }
      return week;
    }
    function renderCalendarSlider() {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      const week = getWeekDays();
      const todayDate = new Date();
      let todayIdx = todayDate.getDay() === 0 ? 6 : todayDate.getDay() - 1;
      week.forEach((d, idx) => {
        const pill = document.createElement('div');
        let pillClass = 'calendar-pill';
        if (idx === selectedDayIdx) pillClass += ' selected';
        if (idx === todayIdx) pillClass += ' today-highlight';
        pill.className = pillClass;
        pill.textContent = d.label;
        pill.style.cursor = 'pointer';
        pill.onclick = () => {
          selectedDayIdx = idx;
          renderCalendarSlider();
          updateMacrosAndLogs();
        };
        calendar.appendChild(pill);
      });
    }
    renderCalendarSlider();
    // Store logs per day in localStorage
    function getDayKey(idx) {
      const week = getWeekDays();
      return 'log_' + week[idx].date;
    }
    // Macro goals
    function getMacroGoals() {
      const macros = JSON.parse(localStorage.getItem('custom_macros')||'{}');
      return {
        calories: macros.calories || parseInt(localStorage.getItem('calories_goal')||'2000'),
        protein: macros.protein || parseInt(localStorage.getItem('protein_goal')||'100'),
        carbs: macros.carbs || parseInt(localStorage.getItem('carbs_goal')||'200'),
        fat: macros.fat || parseInt(localStorage.getItem('fat_goal')||'50')
      };
    }
    // Update macros and logs for selected day
    function updateMacrosAndLogs() {
      // Determină data pentru ziua selectată
      const week = getWeekDays();
      const selectedDate = week[selectedDayIdx].dateObj || new Date();
      const dayKey = 'log_' + selectedDate.toDateString();
      let logs = JSON.parse(localStorage.getItem(dayKey)||'[]');
      // Calculează suma valorilor logate pentru ziua selectată
      let sum = {calories:0, protein:0, carbs:0, fat:0};
      logs.forEach(l => {
        sum.calories += parseFloat(l.calories)||0;
        sum.protein += parseFloat(l.protein)||0;
        sum.carbs += parseFloat(l.carbs)||0;
        sum.fat += parseFloat(l.fat)||0;
      });
      // Obține goalurile
      const goals = getMacroGoals();
      // Actualizează dashboardul cu valorile rămase
      document.getElementById('calNum').textContent = Math.max(0, goals.calories - sum.calories);
      document.getElementById('calLabel').textContent = (goals.calories-sum.calories)>=0?'Calories left':'Calories over';
      document.getElementById('proteinLeft').textContent = Math.max(0, goals.protein - sum.protein)+'g';
      document.getElementById('carbsLeft').textContent = Math.max(0, goals.carbs - sum.carbs)+'g';
      document.getElementById('fatLeft').textContent = Math.max(0, goals.fat - sum.fat)+'g';
      // Progress rings
      function setRing(id, value, max, ringId) {
        const circle = document.getElementById(ringId);
        const r = 15;
        const c = 2 * Math.PI * r;
        const pct = Math.max(0, Math.min(1, value / max));
        circle.setAttribute('stroke-dasharray', c);
        circle.setAttribute('stroke-dashoffset', c * (1 - pct));
      }
      setRing(0, goals.calories-sum.calories, 4000, 'calRing');
      setRing(0, goals.protein-sum.protein, 250, 'proteinRing');
      setRing(0, goals.carbs-sum.carbs, 400, 'carbsRing');
      setRing(0, goals.fat-sum.fat, 120, 'fatRing');
      // Recently logged
      let html = '';
      logs.forEach((l,idx)=>{
        html += `<button class='recent-card' onclick='showLogDetail(${idx})'>
          ${l.image ? `<img src="${l.image}" style="width:38px;height:38px;object-fit:cover;border-radius:0.7rem;margin-bottom:0.4rem;">` : ''}
          <div class='recent-food'>${l.food}</div>
          <div class='recent-cal'>${l.calories} kcal</div>
          <div class='recent-time'>${l.time}</div>
        </button>`;
      });
      document.getElementById('recentList').innerHTML = html;
      calculateStreak();
    }
    window.showLogDetail = function(idx) {
      const logs = JSON.parse(localStorage.getItem(getDayKey(selectedDayIdx))||'[]');
      const l = logs[idx];
      const modal = document.createElement('div');
      modal.className = 'log-modal';
      modal.innerHTML = `<div class='log-modal-content'>
        ${l.image ? `<img src="${l.image}" style="width:90%;max-width:320px;border-radius:1rem;margin-bottom:1.2rem;">` : ''}
        <h3>${l.food}</h3>
        <div>${l.calories} kcal</div>
        <div>Protein: ${l.protein}g</div>
        <div>Carbs: ${l.carbs}g</div>
        <div>Fat: ${l.fat}g</div>
        <div class='recent-time'>${l.time}</div>
        <button class='close-btn' onclick='this.closest(\".log-modal\").remove()'>Close</button>
      </div>`;
      document.body.appendChild(modal);
    };
    // Streak calculation: consecutive days with at least one log, resets if yesterday is missed
    function calculateStreak() {
      const today = new Date();
      const todayKey = today.toDateString();
      let streak = parseInt(localStorage.getItem('streak') || '0');
      let lastLogDate = localStorage.getItem('last_log_date');
      // Check if user logged today
      const logsToday = JSON.parse(localStorage.getItem('log_' + todayKey) || '[]');
      if (logsToday.length > 0) {
        if (lastLogDate !== todayKey) {
          // If last log was yesterday, increment streak, else reset to 1
          const yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
          if (lastLogDate === yesterday.toDateString()) {
            streak++;
          } else {
            streak = 1;
          }
          localStorage.setItem('streak', streak);
          localStorage.setItem('last_log_date', todayKey);
        }
      } else {
        // If today is missed, but last log was not today, check if yesterday was missed
        if (lastLogDate !== todayKey) {
          const yesterday = new Date(today); yesterday.setDate(today.getDate()-1);
          if (lastLogDate !== yesterday.toDateString()) {
            streak = 0;
            localStorage.setItem('streak', streak);
          }
        }
      }
      document.getElementById('streakCount').textContent = streak;
    }
    // Camera FAB (live camera, take photo, send to webhook)
    let cameraStream = null;
    function openCamera() {
      // Modal
      const modal = document.createElement('div');
      modal.className = 'camera-modal';
      modal.innerHTML = `<video id='camVideo' autoplay playsinline></video><br><button onclick='takePhotoAndSend()'>Take Photo</button><button class='close-btn' onclick='closeCamera()'>Close</button><canvas id='camCanvas' style='display:none;'></canvas>`;
      document.body.appendChild(modal);
      // Start camera
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        cameraStream = stream;
        document.getElementById('camVideo').srcObject = stream;
      });
    }
    function closeCamera() {
      const modal = document.querySelector('.camera-modal');
      if (modal) modal.remove();
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    }
    async function takePhotoAndSend() {
      const video = document.getElementById('camVideo');
      const canvas = document.getElementById('camCanvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      canvas.toBlob(function(blob) {
        closeCamera();
        // Save image as base64 in localStorage and redirect to upload.html
        const reader = new FileReader();
        reader.onloadend = function() {
          localStorage.setItem('pending_upload_image', reader.result);
          window.location.href = 'upload.html';
        };
        reader.readAsDataURL(blob);
      }, 'image/jpeg');
    }
    // Initial load
    updateMacrosAndLogs();
  </script>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('loginBtn');
      function googleLoginHandler() {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function(res){
          var user = res.user;
          localStorage.setItem('logged_in','1');
          localStorage.setItem('user_id', user.uid);
          window.location.reload();
        }).catch(function(e){
          alert(e.message);
        });
      }
      if(btn) {
        btn.style.display = '';
        btn.onclick = googleLoginHandler;
      }
      // --- Login Modal Functionality (doar Google) ---
      var googleBtn = document.getElementById('googleSignIn');
      var loginMsg = document.getElementById('loginMsg');
      var closeModalBtn = document.querySelector('#loginModal button[onclick]');
      function closeLoginModal() {
        var modal = document.getElementById('loginModal');
        if(modal) modal.style.display = 'none';
        if(loginMsg) loginMsg.textContent = '';
      }
      if(closeModalBtn) closeModalBtn.onclick = closeLoginModal;
      if(googleBtn) googleBtn.onclick = function() {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function(res){
          var user = res.user;
          localStorage.setItem('logged_in','1');
          localStorage.setItem('user_id', user.uid);
          window.location.reload();
        }).catch(function(e){
          if(loginMsg) loginMsg.textContent = e.message;
        });
      };
      // --- Salvare și restaurare progres per user Google ---
      function getUserId() {
        return localStorage.getItem('user_id') || null;
      }
      // La fiecare updateMacrosAndLogs, salvează progresul sub cheia user_id
      var originalUpdateMacrosAndLogs = window.updateMacrosAndLogs;
      window.updateMacrosAndLogs = function() {
        if(originalUpdateMacrosAndLogs) originalUpdateMacrosAndLogs();
        var userId = getUserId();
        if(userId) {
          var allLogs = {};
          for(var i=0;i<7;i++) {
            var week = (window.getWeekDays && window.getWeekDays()) || [];
            if(week[i]) {
              var key = 'log_' + week[i].date;
              allLogs[key] = localStorage.getItem(key);
            }
          }
          localStorage.setItem('progress_' + userId, JSON.stringify(allLogs));
        }
      };
      // La login, dacă există progres salvat pentru user, îl restaurăm
      var userId = getUserId();
      if(userId) {
        var saved = localStorage.getItem('progress_' + userId);
        if(saved) {
          try {
            var logs = JSON.parse(saved);
            for(var k in logs) {
              if(logs[k]) localStorage.setItem(k, logs[k]);
            }
          } catch(e){}
        }
      }
      // Logout rapid
      var logoutBtn = document.getElementById('logoutBtn');
      if(logoutBtn) {
        logoutBtn.onclick = function() {
          firebase.auth().signOut().finally(function() {
            localStorage.clear();
            window.location.href = 'welcome.html';
          });
        };
      }
      function updateAuthUI() {
        var loginBtn = document.getElementById('loginBtn');
        var userAvatar = document.getElementById('userAvatar');
        var logoutBtn = document.getElementById('logoutBtn');
        firebase.auth().onAuthStateChanged(function(user) {
          if(user) {
            if(loginBtn) loginBtn.style.display = 'none';
            if(userAvatar) {
              userAvatar.style.display = '';
              userAvatar.src = user.photoURL || 'https://www.gravatar.com/avatar/?d=mp';
              userAvatar.title = user.displayName || user.email || '';
            }
            if(logoutBtn) logoutBtn.style.display = '';
          } else {
            if(loginBtn) loginBtn.style.display = '';
            if(userAvatar) userAvatar.style.display = 'none';
            if(logoutBtn) logoutBtn.style.display = 'none';
          }
        });
      }
      updateAuthUI();
      // Detectează utilizator nou și setează trial_start la primul login
      firebase.auth().onAuthStateChanged(function(user) {
        if(user) {
          if(!localStorage.getItem('trial_start')) {
            localStorage.setItem('trial_start', Date.now());
          }
        }
      });
      // La fiecare încărcare, verifică dacă trialul a expirat și nu există abonament
      function checkTrialAndPaywall() {
        const trialStart = parseInt(localStorage.getItem('trial_start') || '0');
        const isSubscribed = localStorage.getItem('subscribed') === '1';
        const now = Date.now();
        const trialActive = trialStart && (now - trialStart < 2 * 24 * 60 * 60 * 1000);
        var paywall = document.getElementById('paywallModal');
        if (!trialActive && !isSubscribed) {
          if(paywall) paywall.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        } else {
          if(paywall) paywall.style.display = 'none';
          document.body.style.overflow = '';
        }
      }
      checkTrialAndPaywall();
      // Buton acces cu parolă admin
      var paywall = document.getElementById('paywallModal');
      if(paywall) {
        var adminBtn = document.createElement('button');
        adminBtn.textContent = 'Acces cu parolă admin';
        adminBtn.style = 'background:#eee;color:#111;border:2px solid #eee;border-radius:1.2rem;padding:1rem 2.2rem;font-size:1.1rem;font-weight:700;cursor:pointer;margin-top:1.2rem;display:block;width:100%';
        adminBtn.onclick = function() {
          var parola = prompt('Introdu parola de acces:');
          if(parola === 'Xxx201027') {
            localStorage.setItem('subscribed','1');
            paywall.style.display = 'none';
            document.body.style.overflow = '';
            alert('Acces deblocat cu succes!');
          } else {
            alert('Parolă greșită!');
          }
        };
        paywall.querySelector('div').appendChild(adminBtn);
      }
      // Poți apela checkTrialAndPaywall() și după login/logout dacă vrei update live
      // Stripe Checkout pentru abonare
      var paywallBtn = document.querySelector('#paywallModal button');
      if(paywallBtn) {
        paywallBtn.disabled = false;
        paywallBtn.style.opacity = '1';
        paywallBtn.style.cursor = 'pointer';
        paywallBtn.textContent = 'Abonează-te (2$/lună)';
        paywallBtn.onclick = function() {
          window.location.href = 'https://buy.stripe.com/test_aFa7sLfPja0oaII3Of5os00';
        };
      }
      // Detectează dacă userul a revenit de pe Stripe cu succes
      if(window.location.search.includes('subscribed=1')) {
        localStorage.setItem('subscribed', '1');
        var paywall = document.getElementById('paywallModal');
        if(paywall) paywall.style.display = 'none';
        document.body.style.overflow = '';
        // Poți afișa un mesaj de succes dacă vrei
        setTimeout(function(){ window.history.replaceState({}, document.title, window.location.pathname); }, 1000);
      }
      // Blochează accesul dacă nu ești logat cu Google
      function checkForceLogin() {
        firebase.auth().onAuthStateChanged(function(user) {
          var forceModal = document.getElementById('forceLoginModal');
          if(!user) {
            if(forceModal) forceModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
          } else {
            if(forceModal) forceModal.style.display = 'none';
            document.body.style.overflow = '';
          }
        });
      }
      checkForceLogin();
      // Funcție unică pentru login Google
      function doGoogleLogin() {
        var provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function() {
          var forceModal = document.getElementById('forceLoginModal');
          if(forceModal) forceModal.style.display = 'none';
          document.body.style.overflow = '';
        });
      }
      // Butonul din modal forțează loginul cu Google
      var forceLoginBtn = document.getElementById('forceLoginBtn');
      if(forceLoginBtn) forceLoginBtn.onclick = googleLoginHandler;
      // Butonul Login din top-bar folosește aceeași funcție
      var loginBtn = document.getElementById('loginBtn');
      if(loginBtn) loginBtn.onclick = googleLoginHandler;
    });
  </script>
</body>
</html> 